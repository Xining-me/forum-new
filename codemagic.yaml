# 工作流配置
workflows:
  android-gradle-build:
    name: Android CI - Gradle build
    
    # 触发条件（Codemagic 正确语法）
    triggers:
      push:
        branches:
          - main
      workflow_dispatch:
        inputs:
          build_type:
            description: 'build type (debug or release)'
            required: false
            default: 'debug'
    
    # 环境配置（移除 variables 嵌套）
    environment:
      node: 18
      java: 17
      ANDROID_API_LEVEL: 33
      BUILD_TOOLS_VERSION: '33.0.2'
    
    # 执行环境
    instance_type: mac_mini_m1
    
    # 构建脚本
    scripts:
      - name: Checkout repository
        script: |
          git clone --branch main $CM_REPOSITORY_URL .
          git checkout $CM_COMMIT_HASH
          git fetch --depth=0
      
      - name: Install npm dependencies
        script: |
          if [ -f package-lock.json ]; then
            npm ci || (echo "npm ci failed, fallback to npm install" && npm install)
          else
            npm install
          fi
      
      - name: Configure Android SDK
        script: |
          echo "Configuring Android SDK..."
          sdkmanager "platform-tools" "platforms;android-$ANDROID_API_LEVEL" "build-tools;$BUILD_TOOLS_VERSION"
          yes | sdkmanager --licenses || true
      
      - name: Prepare JS bundle
        script: |
          mkdir -p android/app/src/main/assets
          mkdir -p android/app/src/main/res
          if [ -f index.js ]; then
            npx react-native bundle --platform android --dev false --entry-file index.js --bundle-output android/app/src/main/assets/index.android.bundle --assets-dest android/app/src/main/res
          fi
      
      - name: Build with Gradle
        script: |
          cd android
          chmod +x gradlew
          if [ "$CM_TRIGGERED_BY_WORKFLOW_DISPATCH" = "true" ] && [ "$build_type" = "release" ]; then
            echo "Building RELEASE"
            ./gradlew clean assembleRelease --stacktrace --no-daemon
          else
            echo "Building DEBUG"
            ./gradlew clean assembleDebug --stacktrace --no-daemon
          fi
    
    # 产物配置
    artifacts:
      - android/app/build/outputs/apk/**/*.apk
    
